# Workflow de ejemplo para construir y desplegar un sitio de Next.js en GitHub Pages
#
# Para más información sobre Next.js consulte: https://nextjs.org/docs/pages/building-your-application/deploying#github-actions
#
name: Desplegar sitio de Next.js en Pages

on:
  # Se ejecuta al hacer push a la rama por defecto (main)
  push:
    branches: ["main"]

  # Permite ejecutar este workflow manualmente desde la pestaña Actions
  workflow_dispatch:

# Establece los permisos del GITHUB_TOKEN para permitir el despliegue en GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Permite solo un despliegue concurrente, saltando las ejecuciones en cola entre la ejecución en progreso y la última en cola.
# Sin embargo, NO cancelamos ejecuciones en progreso para permitir que estos despliegues de producción se completen.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Trabajo de compilación (Build)
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (Descargar código)
        uses: actions/checkout@v4
      - name: Detectar gestor de paquetes
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/package-lock.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            echo "runner=npx --no-install" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "No se pudo determinar el gestor de paquetes"
            exit 1
          fi
      - name: Configurar Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: ${{ steps.detect-package-manager.outputs.manager }}
      - name: Configurar Pages
        uses: actions/configure-pages@v5
        with:
          # Inyecta automáticamente el basePath en tu archivo de configuración de Next.js
          # y desactiva la optimización de imágenes nativa de Next.js (next/image).
          static_site_generator: next
      - name: Restaurar caché
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          # Genera una nueva caché cada vez que cambian los paquetes o archivos fuente.
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          # Si los archivos fuente cambiaron pero los paquetes no, reconstruye desde una caché anterior.
          restore-keys: |
 |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
      - name: Instalar dependencias
        run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}
      - name: Construir con Next.js
        run: ${{ steps.detect-package-manager.outputs.runner }} next build
      - name: Subir artefacto
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  # Trabajo de despliegue (Deploy)
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Desplegar en GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
